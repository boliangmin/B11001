/************************************************************************************************************************************************
* 文件名称：hal_spi.c
* 文件描述：SPI相关驱动函数
* 文件作者：bo.liangmin
* 版本信息：20230814--文件创建
************************************************************************************************************************************************/



/************************************************************************************************************************************************
* include
************************************************************************************************************************************************/
#include "hal_spi.h"
#include "hal_board.h"



/************************************************************************************************************************************************
* define
************************************************************************************************************************************************/
#define SPI_INSTANCE  0                                                           //SPI instance index.
static const nrf_drv_spi_t spi = NRF_DRV_SPI_INSTANCE(SPI_INSTANCE);              //SPI instance.
static volatile bool spi_xfer_done;                                               //Flag used to indicate that SPI instance completed the transfer.



/************************************************************************************************************************************************
* 函数名称：static void HAL_SPI_EventHandler(nrf_drv_spi_evt_t const * p_event, void * p_context)
* 函数说明：SPI中断处理函数
* 输入参数：无
* 输出参数：无
* 返回数值：无
************************************************************************************************************************************************/
static void HAL_SPI_EventHandler(nrf_drv_spi_evt_t const * p_event, void * p_context)
{
    spi_xfer_done = true;
}

/************************************************************************************************************************************************
* 函数名称：void HAL_SPI_Init(void)
* 函数说明：SPI初始化
* 输入参数：无
* 输出参数：无
* 返回数值：无
************************************************************************************************************************************************/
void HAL_SPI_Init(void)
{
    nrf_drv_spi_config_t spi_config = NRF_DRV_SPI_DEFAULT_CONFIG;
    spi_config.mosi_pin = BOARD_SPI_MOSI_PIN;
    spi_config.miso_pin = BOARD_SPI_MISO_PIN;
    spi_config.sck_pin  = BOARD_SPI_CLK_PIN;

    nrf_drv_spi_init(&spi, &spi_config, HAL_SPI_EventHandler, NULL);
}

/************************************************************************************************************************************************
* 函数名称：void HAL_SPI_Trans(uint8_t* send_buff, uint8_t* recv_buff, uint16_t len)
* 函数说明：SPI发送函数
* 输入参数：无
* 输出参数：无
* 返回数值：无
************************************************************************************************************************************************/
void HAL_SPI_Trans(uint8_t* send_buff, uint8_t* recv_buff, uint16_t len)
{
    spi_xfer_done = false;

    if(1 == len)
    {
        nrf_drv_spi_transfer(&spi, send_buff, len, recv_buff, 0);
    }
    else
    {
        nrf_drv_spi_transfer(&spi, send_buff, len, recv_buff, len);
    }

    while(!spi_xfer_done)
    {
        __WFE();
    }
}



/************************************************************************************************************************************************
* end
************************************************************************************************************************************************/


